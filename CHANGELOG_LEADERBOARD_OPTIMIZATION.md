# 排行榜系统优化更新日志

## 更新日期：2026-02-11

## 🎯 更新概述

对排行榜系统进行了全面优化，新增周榜和月榜功能，添加排名变化追踪，优化OJ主页布局。

---

## ✨ 新增功能

### 1. 多维度排行榜系统

#### 总榜（等级分排行）
- 按用户等级分（rating）排序
- 每天记录排名快照
- 显示相比昨天的排名变化

#### 周榜（本周通过题目数）
- 统计本周一0点至今通过的题目数量
- 每周一0点自动重置
- 显示相比上周的排名变化
- 给新用户更多上榜机会

#### 月榜（本月通过题目数）
- 统计本月1号0点至今通过的题目数量
- 每月1号0点自动重置
- 显示相比上月的排名变化
- 长期激励用户持续做题

### 2. 排名变化追踪

**进退情况可视化：**
- ↑X - 排名上升X名（绿色标签）
- ↓X - 排名下降X名（红色标签）
- `-` - 排名保持不变（灰色标签）
- `NEW` - 新上榜用户（黄色标签）

**历史数据存储：**
- 新增 `leaderboard_history` 数据表
- 自动记录每日/每周/每月排名快照
- 支持排名趋势分析

### 3. 定时任务系统

**自动化排名记录：**
- 每天午夜0点保存总榜排名
- 每周一0点保存周榜排名并重置
- 每月1号0点保存月榜排名并重置
- 服务器启动时初始化调度器

---

## 🎨 界面优化

### OJ主页改进

#### 题目跳转框优化
- 增大标题字体（17px，粗体700）
- 缩小输入框和按钮（更紧凑）
- 优化内边距和间距
- 整体高度缩小约40%

#### 10天做题统计图表
- 从7天扩展到10天数据展示
- Y轴自适应数据范围
- 纯色设计（移除渐变）
- 智能tooltip跟随鼠标
- 柱形图+折线图二合一
- 图表高度优化（90px）

**图表交互增强：**
- 鼠标在图表任意位置显示最近日期数据
- 平滑的渐变速过渡动画（150ms ease-out）
- 智能日期匹配算法
- 固定定位tooltip，不被容器遮挡

### 排行榜页面改进

**三标签切换：**
- 🏆 总榜
- 📈 周榜
- 📊 月榜

**表格列调整：**
- 排名（前三名奖牌图标）
- 用户信息（头像+用户名+ID）
- 等级分/通过题目数
- 排名变化（进退情况）

---

## 🔧 技术实现

### 后端改进

**新增API端点：**
```
GET /api/leaderboard?type=total&limit=100
GET /api/leaderboard?type=weekly&limit=100
GET /api/leaderboard?type=monthly&limit=100
```

**数据库变更：**
```sql
CREATE TABLE leaderboard_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  period_type TEXT NOT NULL,  -- 'total', 'weekly', 'monthly'
  period_key TEXT NOT NULL,    -- 日期标识
  rank INTEGER NOT NULL,
  value REAL NOT NULL,
  recorded_at TEXT NOT NULL,
  UNIQUE(user_id, period_type, period_key)
);
```

**辅助函数：**
- `getWeekRange()` - 获取本周日期范围
- `getMonthRange()` - 获取本月日期范围
- `getPreviousPeriodKey()` - 获取上一周期标识
- `saveLeaderboardHistory()` - 保存排名历史
- `scheduleLeaderboardHistory()` - 调度定时任务

### 前端改进

**新增状态管理：**
- `leaderboardType` - 排行榜类型切换
- `chartTooltip` - 图表tooltip状态
- `weeklyStats` - 10天统计数据

**组件优化：**
- 排行榜类型切换逻辑
- 排名变化显示组件
- SVG图表鼠标交互
- 智能tooltip定位

---

## 📊 数据统计

### 周榜规则
- **统计周期**：周一0:00 - 周日23:59
- **重置时间**：每周一0:00
- **评比标准**：本周通过题目数量
- **排序规则**：通过题目数降序

### 月榜规则
- **统计周期**：每月1号0:00 - 月末23:59
- **重置时间**：每月1号0:00
- **评比标准**：本月通过题目数量
- **排序规则**：通过题目数降序

### 总榜规则
- **统计周期**：全时段
- **评比标准**：用户等级分（rating）
- **排序规则**：等级分降序
- **更新频率**：实时更新，每日记录快照

---

## 🎮 用户体验提升

### 激励机制
- ✅ 新用户可通过周榜/月榜快速上榜
- ✅ 老用户在总榜保持竞争优势
- ✅ 周期性重置保持公平性和新鲜感
- ✅ 排名变化可视化增强成就感

### 社交属性
- ✅ 查看其他用户排名变化
- ✅ 对比自己与他人的进步
- ✅ 前三名奖牌荣誉展示
- ✅ 当前用户高亮显示

### 数据可视化
- ✅ 10天做题趋势一目了然
- ✅ 提交数和通过数对比清晰
- ✅ 实时tooltip显示详细数据
- ✅ 自适应Y轴范围

---

## 🔄 兼容性说明

### 数据库迁移
- 自动创建 `leaderboard_history` 表
- 兼容现有用户数据
- 首次启动自动初始化历史数据

### API兼容性
- 保持原有API接口不变
- 新增 `type` 参数向后兼容
- 默认返回总榜数据

---

## 📝 使用说明

### 查看排行榜
1. 访问"排行榜"页面
2. 点击顶部标签切换总榜/周榜/月榜
3. 查看排名和进退情况
4. 当前用户行高亮显示

### 查看统计图表
1. 访问OJ主页
2. 查看"近10天做题统计"图表
3. 鼠标移动到图表上查看详细数据
4. 蓝色柱子=提交数，绿色折线=通过数

---

## 🐛 已知问题

无

---

## 🚀 后续计划

- [ ] 添加年度排行榜
- [ ] 支持按难度分类的排行榜
- [ ] 添加排名历史趋势图
- [ ] 实现用户主页查看功能
- [ ] 添加排行榜分享功能

---

## 👥 贡献者

- Claude Sonnet 4.5

---

## 📄 相关文件

### 后端文件
- `server/db.js` - 数据库表结构
- `server/index.js` - API端点和定时任务

### 前端文件
- `src/App.tsx` - 排行榜页面和OJ主页
- `src/App.css` - 样式定义

### 文档文件
- `CHANGELOG_LEADERBOARD_OPTIMIZATION.md` - 本文档
